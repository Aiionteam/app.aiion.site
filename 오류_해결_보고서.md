# ì˜¤ë¥˜ í•´ê²° ë³´ê³ ì„œ

**ì‘ì„±ì¼**: 2025ë…„ 12ì›” 1ì¼  
**í”„ë¡œì íŠ¸**: app.aiion.site  
**í•´ê²°ëœ ì£¼ìš” ì´ìŠˆ**: ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ê¸°ëŠ¥ ì•ˆì •í™”

---

## ğŸ“‹ í•´ê²°ëœ ë¬¸ì œ ëª©ë¡

### 1. ë¡œê·¸ì¸ ì‹œ ì¤‘ë³µ í‚¤ ì—ëŸ¬ (DataIntegrityViolationException)

#### ë¬¸ì œ ìƒí™©
- ê¸°ì¡´ ì‚¬ìš©ìê°€ ë¡œê·¸ì¸ ì‹œë„ ì‹œ "ì‚¬ìš©ì ìƒì„± ë° ì¡°íšŒ ì‹¤íŒ¨ - user-serviceì™€ í†µì‹ ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤" ì—ëŸ¬ ë°œìƒ
- ë°ì´í„°ë² ì´ìŠ¤ì—ëŠ” ì‚¬ìš©ìê°€ ì¡´ì¬í•˜ì§€ë§Œ ì¡°íšŒ/ìƒì„±ì´ ì‹¤íŒ¨í•˜ëŠ” ë¬¸ì œ

#### ì›ì¸ ë¶„ì„
1. `user-service`ì˜ `save` ë©”ì„œë“œì—ì„œ ì¤‘ë³µ í‚¤ ì—ëŸ¬ ë°œìƒ ì‹œ Hibernate ì„¸ì…˜ì´ ì˜¤ì—¼ë¨
2. `REQUIRES_NEW` íŠ¸ëœì­ì…˜ ì‚¬ìš© ì‹œì—ë„ ê°™ì€ ì—°ê²°ì„ ì‚¬ìš©í•˜ì—¬ PostgreSQLì—ì„œ "current transaction is aborted" ì—ëŸ¬ ë°œìƒ
3. ê¸°ì¡´ ì‚¬ìš©ì ì¡°íšŒ ë¡œì§ì´ ì˜ˆì™¸ ë°œìƒ í›„ ì‹¤í–‰ë˜ì–´ ì‹¤íŒ¨

#### í•´ê²° ë°©ë²•
**íŒŒì¼**: `service/user-service/src/main/java/site/aiion/api/user/UserServiceImpl.java`

```java
@Override
@Transactional
public Messenger save(UserModel userModel) {
    // save ì „ì— ë¨¼ì € ì¡°íšŒ ì‹œë„ (ì¤‘ë³µ í‚¤ ì—ëŸ¬ ë°©ì§€)
    if (userModel.getEmail() != null && userModel.getProvider() != null) {
        Optional<User> existingUser = userRepository.findByEmailAndProvider(
            userModel.getEmail(), 
            userModel.getProvider()
        );
        if (existingUser.isPresent()) {
            // ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì‚¬ìš©ì - ê¸°ì¡´ ì‚¬ìš©ì ì •ë³´ ë°˜í™˜
            UserModel model = entityToModel(existingUser.get());
            return Messenger.builder()
                    .Code(200)
                    .message("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì‚¬ìš©ì: " + existingUser.get().getId())
                    .data(model)
                    .build();
        }
    }
    
    // ì‚¬ìš©ìê°€ ì—†ìœ¼ë©´ ìƒˆë¡œ ì €ì¥
    try {
        // ... ì €ì¥ ë¡œì§
    } catch (DataIntegrityViolationException e) {
        // ì˜ˆì™¸ì ìœ¼ë¡œ ì¤‘ë³µ í‚¤ ì—ëŸ¬ê°€ ë°œìƒí•œ ê²½ìš° ì¬ì¡°íšŒ
        // ...
    }
}
```

**ë³€ê²½ ì‚¬í•­**:
- `save` ì „ì— ë¨¼ì € ì¡°íšŒí•˜ì—¬ ì¤‘ë³µ í‚¤ ì—ëŸ¬ ë°©ì§€
- ì˜ˆì™¸ ë°œìƒ ì‹œì—ë„ ê°™ì€ íŠ¸ëœì­ì…˜ ë‚´ì—ì„œ ì¬ì¡°íšŒ ê°€ëŠ¥
- íŠ¸ëœì­ì…˜ ë³µì¡ë„ ê°ì†Œ

---

### 2. ë„¤ì´ë²„ ë¡œê·¸ì¸ í›„ í™”ë©´ ì „í™˜ ì•ˆ ë¨

#### ë¬¸ì œ ìƒí™©
- ë„¤ì´ë²„ ë¡œê·¸ì¸ì€ ì„±ê³µí•˜ì§€ë§Œ ë©”ì¸ í™”ë©´ìœ¼ë¡œ ì „í™˜ë˜ì§€ ì•ŠìŒ
- JWT í† í°ì€ ì •ìƒì ìœ¼ë¡œ ìˆ˜ì‹ ë˜ì—ˆìœ¼ë‚˜ `isLoggedIn` ìƒíƒœê°€ falseë¡œ ìœ ì§€ë¨

#### ì›ì¸ ë¶„ì„
1. `userSlice.ts`ì˜ `login` í•¨ìˆ˜ì—ì„œ ìƒíƒœ ì—…ë°ì´íŠ¸ ë°©ì‹ ë¬¸ì œ
2. `OAuthCallback` í˜ì´ì§€ì—ì„œ `router.push('/')` ì‚¬ìš© ì‹œ ìƒíƒœ ë°˜ì˜ íƒ€ì´ë° ë¬¸ì œ

#### í•´ê²° ë°©ë²•
**íŒŒì¼**: 
- `frontend/src/store/slices/userSlice.ts`
- `frontend/src/app/login/callback/page.tsx`

**ë³€ê²½ ì‚¬í•­**:
1. `login` í•¨ìˆ˜ì˜ ìƒíƒœ ì—…ë°ì´íŠ¸ ë¡œì§ ê°œì„ 
2. OAuth ì½œë°± í˜ì´ì§€ì—ì„œ `window.location.href = '/'` ì‚¬ìš©í•˜ì—¬ ì™„ì „í•œ í˜ì´ì§€ ë¦¬ë¡œë“œ
3. ìƒíƒœ ì—…ë°ì´íŠ¸ ì§€ì—° ì‹œê°„ ì¶”ê°€ (100ms)

```typescript
// login í•¨ìˆ˜ ê°œì„ 
login: (userInfo) => {
  console.log('[userSlice] login í˜¸ì¶œë¨:', userInfo);
  set((state) => ({ 
    user: { 
      ...state.user,
      user: userInfo, 
      isLoggedIn: true 
    } 
  }));
  console.log('[userSlice] login ì™„ë£Œ - isLoggedIn: true');
},

// OAuth ì½œë°± í˜ì´ì§€
setTimeout(() => {
  window.location.href = '/';
}, 100);
```

---

### 3. ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ì‘ë™ ì•ˆ í•¨

#### ë¬¸ì œ ìƒí™©
- ì„¤ì • í™”ë©´ì˜ ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ í´ë¦­ ì‹œ ì•„ë¬´ ë™ì‘ë„ í•˜ì§€ ì•ŠìŒ

#### ì›ì¸ ë¶„ì„
1. `Button` ì»´í¬ë„ŒíŠ¸ì™€ ì´ë²¤íŠ¸ ì „íŒŒ ë¬¸ì œ
2. `logout` í•¨ìˆ˜ê°€ Zustand storeì—ì„œ ì œëŒ€ë¡œ ê°€ì ¸ì™€ì§€ì§€ ì•ŠìŒ

#### í•´ê²° ë°©ë²•
**íŒŒì¼**: `frontend/src/components/organisms/SettingsView.tsx`

**ë³€ê²½ ì‚¬í•­**:
1. `Button` ì»´í¬ë„ŒíŠ¸ ëŒ€ì‹  ì§ì ‘ `button` íƒœê·¸ ì‚¬ìš©
2. `useStore.getState()`ë¥¼ ì‚¬ìš©í•˜ì—¬ í´ë¦­ ì‹œì ì— ìµœì‹  ìƒíƒœì—ì„œ í•¨ìˆ˜ ê°€ì ¸ì˜¤ê¸°
3. í´ë°± ë¡œì§ ì¶”ê°€ (í•¨ìˆ˜ê°€ ì—†ì–´ë„ ê°•ì œ ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬)

```typescript
<button
  type="button"
  onClick={(e) => {
    e.preventDefault();
    e.stopPropagation();
    const store = useStore.getState();
    const logoutFn = store.user?.logout;
    
    if (logoutFn && typeof logoutFn === 'function') {
      logoutFn();
    } else {
      performLogout(); // í´ë°± ì²˜ë¦¬
    }
  }}
>
  ë¡œê·¸ì•„ì›ƒ
</button>
```

---

### 4. ë¡œê·¸ì•„ì›ƒ ì‹œ ì¿ í‚¤ ì‚­ì œ ëˆ„ë½

#### ë¬¸ì œ ìƒí™©
- ë¡œê·¸ì•„ì›ƒ í›„ì—ë„ ë¸Œë¼ìš°ì € ì¿ í‚¤ê°€ ë‚¨ì•„ìˆì–´ ë‹¤ì‹œ ë¡œê·¸ì¸ ì‹œ ë¬¸ì œ ë°œìƒ
- í¬ë¡¬ ì¿ í‚¤ë¥¼ ìˆ˜ë™ìœ¼ë¡œ ì‚­ì œí•´ì•¼ ì •ìƒ ì‘ë™

#### ì›ì¸ ë¶„ì„
- ë¡œê·¸ì•„ì›ƒ ë¡œì§ì—ì„œ `localStorage`ì™€ `sessionStorage`ë§Œ ì •ë¦¬í•˜ê³  ì¿ í‚¤ëŠ” ì‚­ì œí•˜ì§€ ì•ŠìŒ

#### í•´ê²° ë°©ë²•
**íŒŒì¼**: 
- `frontend/src/store/slices/userSlice.ts`
- `frontend/src/components/organisms/SettingsView.tsx`

**ë³€ê²½ ì‚¬í•­**:
ëª¨ë“  ì¿ í‚¤ë¥¼ ì‚­ì œí•˜ëŠ” ë¡œì§ ì¶”ê°€:

```typescript
// ëª¨ë“  ì¿ í‚¤ ì‚­ì œ
const cookies = document.cookie.split(';');
cookies.forEach(cookie => {
  const eqPos = cookie.indexOf('=');
  const name = eqPos > -1 ? cookie.substring(0, eqPos).trim() : cookie.trim();
  // ëª¨ë“  ê²½ë¡œì™€ ë„ë©”ì¸ì—ì„œ ì¿ í‚¤ ì‚­ì œ ì‹œë„
  document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/`;
  document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;domain=${window.location.hostname}`;
  document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;domain=.${window.location.hostname}`;
  document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;domain=localhost`;
});
```

---

## ğŸ”§ ê¸°ìˆ ì  ê°œì„  ì‚¬í•­

### 1. ë¡œê·¸ì¸ í”Œë¡œìš° ë‹¨ìˆœí™”

**ë³€ê²½ ì „**:
```
ì‚¬ìš©ì ì¡°íšŒ â†’ ì—†ìœ¼ë©´ ì €ì¥ â†’ ì—ëŸ¬ ë°œìƒ â†’ ì¬ì¡°íšŒ â†’ ì‹¤íŒ¨
```

**ë³€ê²½ í›„**:
```
ì‚¬ìš©ì ì¡°íšŒ â†’ ìˆìœ¼ë©´ í†µê³¼
           â†’ ì—†ìœ¼ë©´ ì €ì¥ â†’ ì„±ê³µ
                        â†’ ì‹¤íŒ¨ ì‹œ ì¬ì¡°íšŒ â†’ í†µê³¼
```

### 2. ì¸ì¦ ë¡œì§ ê°œì„ 

**auth-service**:
- `GoogleController`, `NaverController`, `KakaoController` ë¡œì§ í†µì¼
- ê°„ë‹¨í•œ í”Œë¡œìš°: ì¡°íšŒ â†’ ì—†ìœ¼ë©´ ìƒì„± â†’ ì‹¤íŒ¨ ì‹œ ì¬ì¡°íšŒ

**user-service**:
- `save` ì „ ì¡°íšŒë¡œ ì¤‘ë³µ í‚¤ ì—ëŸ¬ ë°©ì§€
- íŠ¸ëœì­ì…˜ ì²˜ë¦¬ ë‹¨ìˆœí™”

### 3. ë¡œê·¸ì•„ì›ƒ ë¡œì§ ê°•í™”

**ì‚­ì œ ëŒ€ìƒ**:
- âœ… localStorage (access_token, refresh_token, auth_provider, app-storage)
- âœ… sessionStorage (ì „ì²´)
- âœ… ì¿ í‚¤ (ëª¨ë“  ì¿ í‚¤)
- âœ… Zustand ìƒíƒœ (user, isLoggedIn)

**ë¦¬ë‹¤ì´ë ‰íŠ¸**:
- `window.location.replace('/')` ì‚¬ìš© (íˆìŠ¤í† ë¦¬ ë¯¸ìƒì„±)

---

## ğŸ“ ìˆ˜ì •ëœ íŒŒì¼ ëª©ë¡

### Backend
1. `service/user-service/src/main/java/site/aiion/api/user/UserServiceImpl.java`
   - `save` ë©”ì„œë“œ: save ì „ ì¡°íšŒ ë¡œì§ ì¶”ê°€
   - ì¤‘ë³µ í‚¤ ì—ëŸ¬ ì²˜ë¦¬ ê°œì„ 

2. `service/auth-service/src/main/java/site/hohyun/api/user/UserServiceClient.java`
   - `findByEmailAndProvider`: 404 ì—ëŸ¬ ì²˜ë¦¬ ê°œì„ 
   - ì—ëŸ¬ ë©”ì‹œì§€ ë° ë¡œê¹… ê°œì„ 

3. `service/auth-service/src/main/java/site/hohyun/api/google/GoogleController.java`
4. `service/auth-service/src/main/java/site/hohyun/api/naver/NaverController.java`
5. `service/auth-service/src/main/java/site/hohyun/api/kakao/KakaoController.java`
   - ì‚¬ìš©ì ì¡°íšŒ/ìƒì„± ë¡œì§ ë‹¨ìˆœí™” ë° í†µì¼

### Frontend
1. `frontend/src/store/slices/userSlice.ts`
   - `login` í•¨ìˆ˜: ìƒíƒœ ì—…ë°ì´íŠ¸ ë¡œì§ ê°œì„ 
   - `logout` í•¨ìˆ˜: ì¿ í‚¤ ì‚­ì œ ë¡œì§ ì¶”ê°€, ë¡œê¹… ê°œì„ 

2. `frontend/src/components/organisms/SettingsView.tsx`
   - ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼: ì§ì ‘ button íƒœê·¸ ì‚¬ìš©
   - `useStore.getState()` ì‚¬ìš©ìœ¼ë¡œ í•¨ìˆ˜ ê°€ì ¸ì˜¤ê¸°
   - í´ë°± ë¡œì§ ì¶”ê°€

3. `frontend/src/app/login/callback/page.tsx`
   - ë¦¬ë‹¤ì´ë ‰íŠ¸ ë°©ì‹ ë³€ê²½: `router.push` â†’ `window.location.href`
   - ìƒíƒœ ë°˜ì˜ ì§€ì—° ì‹œê°„ ì¶”ê°€

4. `frontend/src/app/page.tsx`
   - í† í° í™•ì¸ ë¡œì§ ê°œì„ 
   - ë¡œê·¸ì¸ í™”ë©´ í‘œì‹œ ë¡œì§ ê°•í™”

---

## âœ… í…ŒìŠ¤íŠ¸ ê²°ê³¼

### ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸
- âœ… Google ë¡œê·¸ì¸: ì •ìƒ ì‘ë™
- âœ… Naver ë¡œê·¸ì¸: ì •ìƒ ì‘ë™ (í™”ë©´ ì „í™˜ í¬í•¨)
- âœ… Kakao ë¡œê·¸ì¸: ì •ìƒ ì‘ë™
- âœ… ê¸°ì¡´ ì‚¬ìš©ì ì¬ë¡œê·¸ì¸: ì •ìƒ ì‘ë™ (ì¤‘ë³µ í‚¤ ì—ëŸ¬ ì—†ìŒ)

### ë¡œê·¸ì•„ì›ƒ í…ŒìŠ¤íŠ¸
- âœ… ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ í´ë¦­: ì •ìƒ ì‘ë™
- âœ… ìƒíƒœ ì •ë¦¬: localStorage, sessionStorage, ì¿ í‚¤ ëª¨ë‘ ì‚­ì œ í™•ì¸
- âœ… í˜ì´ì§€ ë¦¬ë‹¤ì´ë ‰íŠ¸: ëœë”© í˜ì´ì§€ë¡œ ì •ìƒ ì´ë™
- âœ… ì¬ë¡œê·¸ì¸ ê°€ëŠ¥: ë‹¤ë¥¸ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸ ê°€ëŠ¥

---

## ğŸ¯ ê°œì„  íš¨ê³¼

1. **ì•ˆì •ì„± í–¥ìƒ**
   - ì¤‘ë³µ í‚¤ ì—ëŸ¬ ì™„ì „ í•´ê²°
   - ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ í”Œë¡œìš° ì•ˆì •í™”

2. **ì‚¬ìš©ì ê²½í—˜ ê°œì„ **
   - ë¡œê·¸ì¸ í›„ ì¦‰ì‹œ ë©”ì¸ í™”ë©´ ì „í™˜
   - ë¡œê·¸ì•„ì›ƒ í›„ ì™„ì „í•œ ìƒíƒœ ì´ˆê¸°í™”

3. **ì½”ë“œ í’ˆì§ˆ ê°œì„ **
   - ë¡œì§ ë‹¨ìˆœí™” ë° í†µì¼
   - ì—ëŸ¬ ì²˜ë¦¬ ê°•í™”
   - ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€

---

## ğŸ“Œ ì£¼ì˜ì‚¬í•­ ë° í–¥í›„ ê°œì„  ì‚¬í•­

### ì£¼ì˜ì‚¬í•­
1. **ë°ì´í„°ë² ì´ìŠ¤ ë°ì´í„° ë³´ì¡´**: ë¡œê·¸ì•„ì›ƒ ì‹œì—ë„ `users` í…Œì´ë¸” ë°ì´í„°ëŠ” ìœ ì§€ë©ë‹ˆë‹¤
2. **ì¿ í‚¤ ì‚­ì œ**: ëª¨ë“  ì¿ í‚¤ë¥¼ ì‚­ì œí•˜ë¯€ë¡œ ë‹¤ë¥¸ ì„œë¹„ìŠ¤ì˜ ì¿ í‚¤ë„ ì˜í–¥ì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤

### í–¥í›„ ê°œì„  ê°€ëŠ¥ ì‚¬í•­
1. íŠ¹ì • ì¿ í‚¤ë§Œ ì„ íƒì  ì‚­ì œ (OAuth ê´€ë ¨ ì¿ í‚¤ë§Œ)
2. ë¡œê·¸ì•„ì›ƒ API ì—”ë“œí¬ì¸íŠ¸ ì¶”ê°€ (ì„œë²„ ì¸¡ í† í° ë¬´íš¨í™”)
3. ë¡œê·¸ì•„ì›ƒ ë¡œë”© ìƒíƒœ í‘œì‹œ

---

## ğŸ“š ì°¸ê³  ìë£Œ

- Zustand ê³µì‹ ë¬¸ì„œ: https://zustand-demo.pmnd.rs/
- Spring Data JPA íŠ¸ëœì­ì…˜ ê´€ë¦¬: https://docs.spring.io/spring-data/jpa/docs/current/reference/html/
- PostgreSQL íŠ¸ëœì­ì…˜ ê´€ë¦¬: https://www.postgresql.org/docs/current/tutorial-transactions.html

---

**ì‘ì„±ì**: AI Assistant  
**ê²€í†  ìƒíƒœ**: âœ… ì™„ë£Œ

